{{ $node := .node }}
{{ $units := .units }}
{{ $site := .Site }}
{{ $personnel := $site.Data.personnel | default slice }}

<!-- Filter personnel for this node -->
{{ $unitPersonnel := slice }}
{{ range $personnel }}
    {{ if strings.Contains (lower .unit) (lower $node.name) }}
        {{ $unitPersonnel = $unitPersonnel | append . }}
    {{ end }}
{{ end }}

<div class="orbat-node-card h-full flex flex-col bg-[#1a1a1a] border border-white/10 rounded-md overflow-hidden relative group/card">
    <!-- Node Header (Like Obsidian) -->
    <div class="px-4 py-2 bg-white/[0.03] border-b border-white/5 flex justify-between items-center shrink-0">
        <div class="flex items-center space-x-2">
            {{ if $node.icon }}
            {{ $icon := resources.Get $node.icon }}
            {{ if $icon }}
            <img src="{{ $icon.RelPermalink }}" class="w-4 h-4 object-contain opacity-60" data-icon-path="{{ $node.icon }}">
            {{ end }}
            {{ end }}
            <span class="text-[9px] font-black text-white/40 uppercase tracking-widest font-mono truncate">{{ $node.callsign | default "NODE" }}</span>
        </div>
        
        <!-- Admin Structural Controls -->
        <div class="admin-controls flex space-x-1 opacity-0 group-hover/card:opacity-100 transition-opacity hidden">
            <div class="node-drag-handle p-1 hover:text-[var(--primary)] cursor-move">✥</div>
            <button onclick="removeOrbatNode(this)" class="p-1 hover:text-red-500">×</button>
        </div>
    </div>

    <!-- Node Body -->
    <div class="p-4 flex-grow overflow-y-auto custom-scrollbar space-y-4 pointer-events-auto">
        <h5 class="text-sm font-bold text-white uppercase tracking-tight m-0 editable-field" data-key="name">{{ $node.name }}</h5>

        <!-- Personnel List (Dynamic) -->
        {{ if $unitPersonnel }}
        <div class="space-y-1.5 pt-2 border-t border-white/5">
            {{ range $unitPersonnel }}
            <div class="flex justify-between items-center text-[8px] font-mono {{ if .is_leadership }}text-[var(--primary)]{{ end }}">
                <span class="opacity-50 uppercase">{{ .rank }}</span>
                <span class="font-bold">{{ .name }}</span>
            </div>
            {{ end }}
        </div>
        {{ end }}
    </div>

    <!-- Obsidian-style Edge Connection Points (Visible in Edit Mode) -->
    <div class="connection-points absolute inset-0 pointer-events-none hidden">
        <div class="c-point top" onmousedown="startDrawingLink(event, 'top')"></div>
        <div class="c-point right" onmousedown="startDrawingLink(event, 'right')"></div>
        <div class="c-point bottom" onmousedown="startDrawingLink(event, 'bottom')"></div>
        <div class="c-point left" onmousedown="startDrawingLink(event, 'left')"></div>
    </div>
</div>