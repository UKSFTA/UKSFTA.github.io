{{ $orbat := .Site.Data.orbat_v2 }}
{{ $units := .Site.Data.units }}
<div class="orbat-canvas-area relative w-[10000px] h-[10000px]">
  <!-- Layer 1: Drafting Grid (SVG implementation) -->
  <svg class="absolute inset-0 w-full h-full pointer-events-none z-0">
    <defs>
      <!-- Minor Grid: 40px -->
      <pattern id="smallGrid" width="40" height="40" patternUnits="userSpaceOnUse">
        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1" vector-effect="non-scaling-stroke"/>
      </pattern>
      <!-- Major Grid: 200px (contains 5x5 small grids) -->
      <pattern id="grid" width="200" height="200" patternUnits="userSpaceOnUse">
        <rect width="200" height="200" fill="url(#smallGrid)"/>
        <path d="M 200 0 L 0 0 0 200" fill="none" stroke="rgba(179, 153, 93, 0.15)" stroke-width="1.5" vector-effect="non-scaling-stroke"/>
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grid)" />
  </svg>

  <!-- Layer 2: SVG Connector Layer -->
  <svg id="orbat-connectors" class="absolute inset-0 w-full h-full pointer-events-none z-0">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="rgba(179, 153, 93, 0.8)" />
      </marker>
    </defs>
    {{ range $orbat.edges }}
      <path
        class="orbat-link"
        id="edge-{{ .id }}"
        data-source="{{ .fromNode }}"
        data-target="{{ .toNode }}"
        data-from-side="{{ .fromSide }}"
        data-to-side="{{ .toSide }}"
        d=""
        fill="none"
        stroke="rgba(179, 153, 93, 0.4)"
        stroke-width="2"
        marker-end="url(#arrowhead)"
      />
    {{ end }}
    <path
      id="temp-link"
      d=""
      fill="none"
      stroke="var(--primary)"
      stroke-width="2"
      stroke-dasharray="5,5"
      class="hidden"
    />
  </svg>
  <!-- Node Layer -->
  <div id="orbat-nodes-layer" class="absolute inset-0 z-10">
    {{ range $orbat.nodes }}
      <div
        class="orbat-node-wrapper absolute shadow-2xl"
        id="node-{{ .id }}"
        style="left: calc(5000px + {{ .x }}px);
                    top: calc(5000px + {{ .y }}px);
                    width: {{ .width }}px;
                    height: {{ .height }}px"
        data-id="{{ .id }}"
        data-x="{{ .x }}"
        data-y="{{ .y }}"
        data-w="{{ .width }}"
        data-h="{{ .height }}"
      >
        {{ partial "widgets/orbat-node.html" (dict "node" . "units" $units "Site" $.Site) }}
      </div>
    {{ end }}
  </div>
</div>
