{{ define "main" }}
<div class="workstation-container transition-colors duration-300 relative flex-row gap-px bg-mod-grey-3 dark:bg-mod-grey-1">
    <!-- LEFT: RECON_EXPLORER -->
    <aside class="w-[380px] flex flex-col bg-[var(--bg-page)] dark:bg-[#1d2329] overflow-hidden shadow-2xl relative z-20">
        <header class="h-20 border-b border-mod-grey-3 dark:border-mod-grey-1 flex items-center justify-between px-8 bg-mod-grey-4 dark:bg-mod-black/20 shrink-0">
            <span class="text-[11px] font-black uppercase text-mod-purple dark:text-mod-grey-3 tracking-[0.4em] font-mono leading-none">// Operational_Grid</span>
            <button onclick="window.openIngestionHub()" class="p-2.5 hover:bg-mod-purple hover:text-white border border-mod-grey-3 dark:border-mod-grey-1 text-mod-purple transition-all shadow-sm" title="Field Uplink">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
            </button>
        </header>

        <div class="p-8 border-b border-mod-grey-3 dark:border-mod-grey-1 bg-[var(--bg-page)]">
            <div class="relative">
                <input type="text" placeholder="FILTER_RECORDS..." class="w-full bg-mod-grey-4 dark:bg-mod-grey-1/10 border border-mod-grey-3 dark:border-mod-grey-1 p-4 text-[10px] uppercase tracking-[0.2em] text-mod-black dark:text-white font-mono focus:outline-none focus:border-mod-purple transition-all shadow-inner">
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-4 bg-[var(--bg-page)] dark:bg-[#1d2329]">
            {{ with .Site.GetPage "section" "campaigns" }}
            {{ range (sort .Sections "Date" "desc") }}
            {{ $campaign := . }}
            <div class="campaign-node mb-6">
                <div onclick="toggleDrawer(this); updateCampaignContext('{{ $campaign.Title }}', '{{ $campaign.Params.image }}', '{{ .Content | plainify | htmlUnescape }}')" 
                     class="px-6 py-4 flex items-center justify-between hover:bg-mod-grey-4 dark:hover:bg-[var(--bg-page)]/5 cursor-pointer text-mod-grey-1 dark:text-white group transition-all border border-transparent hover:border-mod-grey-3 dark:hover:border-mod-grey-1 shadow-sm" 
                     data-id="{{ $campaign.File.ContentBaseName }}">
                    <div class="flex items-center gap-5">
                        <svg class="w-5 h-5 text-mod-grey-3 group-hover:text-mod-purple transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        <span class="font-black text-xs truncate uppercase tracking-tight font-industrial">{{ $campaign.Title }}</span>
                    </div>
                    <svg class="w-4 h-4 text-mod-grey-3 transition-transform duration-300 arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                </div>

                <div class="drawer-content hidden ml-8 mt-2 space-y-px border-l-2 border-mod-grey-3 dark:border-mod-grey-1 pl-6">
                    {{ range (sort $campaign.Sections "Date" "desc") }}
                    {{ $event := . }}
                    <div class="event-node">
                        <div onclick="toggleDrawer(this); selectEvent('{{ $campaign.File.ContentBaseName }}', '{{ $event.File.ContentBaseName }}', '{{ $event.File.Dir }}')" 
                             class="px-5 py-3 flex items-center justify-between hover:bg-mod-grey-4 dark:hover:bg-[var(--bg-page)]/5 cursor-pointer text-mod-grey-2 hover:text-mod-black dark:hover:text-white transition-all">
                            <span class="text-[11px] font-black uppercase tracking-tight">{{ $event.Title }}</span>
                            <svg class="w-3.5 h-3.5 text-mod-grey-3 transition-transform duration-300 arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                        <div class="drawer-content hidden space-y-px border-l border-mod-grey-3 dark:border-mod-grey-1 pl-4 py-2">
                            {{ range (sort $event.RegularPages "Date" "desc") }}
                            <div onclick="loadFile('{{ .File.Path }}', '{{ .Title }}', this)" class="file-item px-5 py-4 hover:bg-[var(--bg-page)] dark:hover:bg-[var(--bg-page)]/10 cursor-pointer flex flex-col gap-2 transition-all border-l-4 border-transparent hover:border-mod-purple" data-path="{{ .File.Path }}">
                                <span class="text-[11px] font-black uppercase tracking-tight text-mod-grey-1 truncate dark:text-mod-grey-3">{{ .Title }}</span>
                                <span class="text-[8px] font-mono text-mod-grey-2 uppercase font-black tracking-widest">{{ .Date.Format "021504Z JAN 06" }}</span>
                            </div>
                            {{ end }}
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
            {{ end }}
            {{ end }}
        </div>
    </aside>

    <!-- RIGHT: MAIN WORKSPACE -->
    <main class="flex-1 flex flex-col bg-[var(--bg-page)] overflow-hidden relative z-10">
        <!-- Tab Bar -->
        <div class="h-20 bg-mod-grey-4 dark:bg-[#1d2329] border-b border-mod-grey-3 dark:border-mod-grey-1 flex items-center px-10 gap-10 shrink-0">
            <div class="h-full px-12 flex items-center gap-6 bg-[var(--bg-page)] border-x border-mod-grey-3 dark:border-mod-grey-1 border-t-8 border-t-mod-purple shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
                <svg class="w-6 h-6 text-mod-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span id="active-file-title" class="font-industrial font-black text-xl tracking-[0.2em] uppercase text-mod-black dark:text-white">AWAITING_SELECTION</span>
            </div>
            
            <div class="flex-1 flex items-center justify-end gap-10">
                <div id="sync-status" class="flex items-center gap-3 bg-mod-green/10 px-4 py-2 border border-mod-green/20">
                    <span class="w-2 h-2 bg-mod-green rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-mono font-black text-mod-green uppercase tracking-widest">STABLE_LINK</span>
                </div>
                <div class="h-10 w-px bg-mod-grey-3 dark:bg-mod-grey-1"></div>
                <span id="zulu-time" class="text-xl font-industrial font-black text-mod-black dark:text-white tracking-widest">00:00:00Z</span>
            </div>
        </div>

        <!-- Editor/Preview Grid -->
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 overflow-hidden bg-mod-grey-3 dark:bg-mod-grey-1 gap-px">
            <!-- Editor Pane -->
            <div class="lg:col-span-7 flex flex-col bg-[var(--bg-page)] relative">
                <div class="h-14 bg-mod-grey-4 dark:bg-[#1d2329] border-b border-mod-grey-3 dark:border-mod-grey-1 flex items-center justify-between px-10 shrink-0">
                    <div id="template-selector-container" class="hidden flex items-center gap-6">
                        <select id="doc-type-selector" class="bg-[var(--bg-page)] border border-mod-grey-3 dark:border-mod-grey-1 text-[10px] font-black uppercase tracking-widest px-4 py-2 outline-none cursor-pointer focus:border-mod-purple">
                            <option value="">-- INJECT_TEMPLATE --</option>
                            <option value="conop">CONOP_SPEC</option>
                            <option value="sitrep">SITREP_FRAG</option>
                            <option value="aar">AAR_RETRO</option>
                            <option value="intel">INTSUM_BRIEF</option>
                        </select>
                    </div>
                    <span id="char-count" class="text-[9px] font-mono font-bold text-mod-grey-2 uppercase">0000 CHARS</span>
                </div>
                <textarea id="vault-editor" class="flex-1 bg-transparent p-16 outline-none resize-none font-mono text-lg text-mod-black dark:text-white leading-relaxed selection:bg-mod-purple selection:text-white custom-scrollbar" spellcheck="false" placeholder="// INITIALIZE_DATA_ENTRY_PROTOCOL..."></textarea>
            </div>
            
            <!-- Preview Pane -->
            <div class="lg:col-span-5 flex flex-col bg-mod-grey-4 dark:bg-[#1d2329] overflow-y-auto custom-scrollbar">
                <div class="h-14 bg-mod-grey-4 dark:bg-[#1d2329] border-b border-mod-grey-3 dark:border-mod-grey-1 flex items-center px-10 shrink-0">
                    <span class="text-[10px] font-black uppercase tracking-[0.3em] text-mod-grey-2 font-mono">Institutional_Preview</span>
                </div>
                <div id="vault-preview" class="p-16 prose prose-2xl max-w-none dark:prose-invert prose-headings:font-industrial prose-p:font-body">
                    <div class="flex flex-col items-center justify-center py-40 opacity-[0.05] grayscale">
                        {{ $logo := resources.Get "icons/MOD.png" }}
                        <img src="{{ $logo.RelPermalink }}" class="h-64 mb-10 no-invert" alt="MOD Crown">
                        <span class="text-xl font-mono tracking-[0.8em] uppercase font-black">Awaiting_Data</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Footer -->
        <footer class="h-12 bg-[var(--bg-page)] border-t border-mod-grey-3 dark:border-mod-grey-1 flex items-center justify-between px-10 shrink-0">
            <div class="flex gap-12 text-[9px] font-mono font-bold text-mod-grey-2 uppercase tracking-widest">
                <span id="cursor-pos">Ln 1, Col 1</span>
                <span id="file-status" class="text-mod-green">NODE_STABLE_READY</span>
            </div>
            <button id="sync-btn" onclick="saveFragment()" class="hidden bg-mod-green text-white px-8 h-full font-black uppercase text-[10px] tracking-[0.3em] shadow-lg hover:bg-green-700 transition-all">
                Sync_to_Registry
            </button>
        </footer>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Preserving document logic while using updated IDs and Classes
    function updateZuluTime() {
        const now = new Date();
        const el = document.getElementById('zulu-time');
        if (el) el.innerText = now.toISOString().split('T')[1].split('.')[0] + 'Z';
    }
    setInterval(updateZuluTime, 1000);
    updateZuluTime();

    function toggleDrawer(el) {
        const drawer = el.nextElementSibling;
        const arrow = el.querySelector('.arrow-icon');
        if (drawer && drawer.classList.contains('drawer-content')) {
            drawer.classList.toggle('hidden');
            const isOpen = !drawer.classList.contains('hidden');
            if (arrow) arrow.style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
        }
    }

    function selectEvent(campaignId, eventId, dir) {
        const tsContainer = document.getElementById('template-selector-container');
        const syncBtn = document.getElementById('sync-btn');
        if (tsContainer) tsContainer.classList.remove('hidden');
        if (syncBtn) syncBtn.classList.remove('hidden');
    }

    async function loadFile(path, title, el) {
        try {
            const res = await fetch(`/api/file?path=${encodeURIComponent(path)}`);
            if (res.ok) {
                const data = await res.json();
                const editor = document.getElementById('vault-editor');
                const preview = document.getElementById('vault-preview');
                editor.value = data.content;
                document.getElementById('active-file-title').innerText = title.toUpperCase();
                if (preview) preview.innerHTML = marked.parse(data.content);
                document.querySelectorAll('.file-item').forEach(f => f.classList.remove('bg-[var(--bg-page)]', 'dark:bg-[var(--bg-page)]/10', 'border-mod-purple'));
                el.classList.add('bg-[var(--bg-page)]', 'dark:bg-[var(--bg-page)]/10', 'border-mod-purple');
                document.getElementById('template-selector-container').classList.remove('hidden');
                document.getElementById('sync-btn').classList.remove('hidden');
            }
        } catch (e) { console.error(e); }
    }
</script>
{{ end }}
