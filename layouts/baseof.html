<!DOCTYPE html>
<html lang="{{ site.Language.LanguageCode }}" class="h-full">
<head>
  {{ partial "head.html" . }}
  {{ partial "head/skin.html" . }}
</head>
{{ $unit := .Params.unit | default .Section | default "sas" }}
<body class="unit-{{ lower $unit }} {{ if or .IsHome (eq .Layout "register") (eq .Layout "gate") (eq .Layout "archive-covert") }}snap-y snap-mandatory h-dvh overflow-y-auto{{ end }}">
  
  <!-- Tier 1: System Status Superior Rule -->
  <div class="fixed top-0 left-0 w-full z-[3000] bg-black border-b border-white/5 h-[32px] flex items-center">
    <div class="container-uksf flex justify-between items-center w-full">
      <div class="flex items-center space-x-6">
        <div class="flex items-center space-x-2">
            <span class="text-[6px] font-mono text-gray-700 uppercase tracking-widest font-black">SYS_STATUS:</span>
            <span class="text-[7px] font-mono text-green-500 uppercase tracking-widest font-black">{{ site.Params.intelligence.sys_status | default "STABLE" }}</span>
        </div>
        <div class="h-3 w-px bg-white/10 hidden sm:block"></div>
        <div class="flex items-center space-x-2">
            <span class="text-[6px] font-mono text-gray-700 uppercase tracking-widest font-black">COMMS_LINK:</span>
            <span class="discord-online-count text-[7px] font-mono text-white uppercase tracking-widest font-black">--</span>
        </div>
        <div class="h-3 w-px bg-white/10 hidden sm:block"></div>
        <span class="text-[7px] font-mono text-gray-600 uppercase tracking-[0.6em] cursor-default select-none" id="ghost-node">UKSF TASKFORCE ALPHA // COMMAND_PORTAL</span>
      </div>
      <div class="flex items-center space-x-8 text-[7px] font-mono text-gray-600 uppercase tracking-widest">
        <span class="hidden md:block">NODE: {{ site.Params.intelligence.node_id | default "JSFC-01" }}</span>
        <span class="text-[var(--primary)] font-bold">Classification: {{ site.Params.intelligence.classification | default "OFFICIAL_SENSITIVE" }}</span>
      </div>
    </div>
  </div>

  <!-- Tier 2: Institutional Navigation -->
  <header class="nav-header top-[32px]">
    <div class="container-uksf flex justify-between items-center h-full">
      <div class="flex items-center space-x-12">
        <a href="/" class="no-underline group flex items-center space-x-10">
          <div class="relative p-1">
            <!-- HUD Bracket Decorations -->
            <div class="absolute -top-1 -left-1 w-2 h-2 border-t border-l border-[var(--primary)]/40 group-hover:border-[var(--primary)] transition-colors"></div>
            <div class="absolute -bottom-1 -right-1 w-2 h-2 border-b border-r border-[var(--primary)]/40 group-hover:border-[var(--primary)] transition-colors"></div>
            
            {{ $tfa_logo := resources.Get "icons/TFA.png" }}
            {{ if $tfa_logo }}
            <img src="{{ $tfa_logo.RelPermalink }}" alt="UKSFTA" class="h-12 w-auto grayscale opacity-90 group-hover:opacity-100 transition-all duration-500">
            {{ end }}
          </div>
          <div class="flex flex-col">
            <span class="text-white font-bold text-3xl tracking-tight leading-none font-industrial">UKSFTA</span>
            <span class="text-[7px] font-mono text-gray-500 uppercase tracking-[0.6em] mt-1.5 border-t border-white/10 pt-1.5">Joint Command Node</span>
          </div>
        </a>
      </div>
      
      <nav class="hidden lg:flex items-center space-x-14">
        {{ range site.Menus.main }}
        <a href="{{ .URL }}" class="nav-link !text-[9px] !tracking-[0.5em] {{ if eq $.RelPermalink .URL }}active{{ end }}">
          {{ .Name }}
        </a>
        {{ end }}
      </nav>

      <div class="hidden sm:flex items-center space-x-8 border-l border-white/5 pl-8">
        <div class="flex flex-col items-end">
          <span class="text-[6px] font-mono text-gray-600 uppercase tracking-widest mb-1">UTC_SYNC</span>
          <span class="text-[11px] font-mono text-white font-black tracking-widest" id="clock">00:00:00</span>
        </div>
      </div>
    </div>
    <!-- Technical Scan Line Decoration -->
    <div class="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-[var(--primary)]/20 to-transparent"></div>
  </header>

  <main class="contents">
    {{ block "main" . }}{{ end }}
  </main>

  <!-- REFINED INSTITUTIONAL FOOTER -->
  <footer class="py-12 lg:py-24 bg-black border-t border-white/5 relative overflow-hidden snap-start">
    <div class="container-uksf relative z-10 w-full">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-16 items-start border-b border-white/5 pb-16">
        
        <div class="md:col-span-5 space-y-8">
          <div class="flex items-center space-x-6">
            {{ $tfa_logo := resources.Get "icons/TFA.png" }}
            {{ if $tfa_logo }}
            <img src="{{ $tfa_logo.RelPermalink }}" alt="UKSFTA" class="h-14 opacity-60 grayscale">
            {{ end }}
            <div class="flex flex-col">
                <h2 class="text-3xl m-0 tracking-tighter font-black uppercase">UKSF Taskforce Alpha <br>Joint Operations</h2>
                <span class="text-[8px] font-mono text-gray-600 uppercase tracking-widest mt-2">Milsim Community // Heritage Simulated</span>
            </div>
          </div>
          <p class="max-w-md text-gray-500 text-[11px] font-normal leading-relaxed uppercase tracking-wider">UKSFTA is an Arma 3 Milsim group. We are not affiliated with, endorsed by, or part of the UK Ministry of Defence or HM Armed Forces.</p>
        

        </div>
        
        <div class="md:col-span-2 space-y-6">
          <span class="text-[9px] font-black text-white uppercase tracking-[0.4em]">Operations</span>
          <ul class="space-y-3 list-none p-0 text-[10px] uppercase tracking-widest font-bold text-gray-600">
            <li><a href="/recruitment/" class="hover:text-white transition-colors no-underline">Join the Unit</a></li>
            <li><a href="/sas/" class="hover:text-white transition-colors no-underline">22nd SAS Domain</a></li>
            <li><a href="/sbs/" class="hover:text-white transition-colors no-underline">Boat Service</a></li>
            <li><a href="/stories/" class="hover:text-white transition-colors no-underline">Operation Logs</a></li>
          </ul>
        </div>

        <div class="md:col-span-2 space-y-6">
          <span class="text-[9px] font-black text-white uppercase tracking-[0.4em]">Community</span>
          <ul class="space-y-3 list-none p-0 text-[10px] uppercase tracking-widest font-bold text-gray-600">
            <li><a href="https://discord.gg/2jNqa3zPRH" class="hover:text-white transition-colors no-underline">Unit Discord</a></li>
            <li><a href="https://discord.com/channels/1321236261553573928/1322946903796617357" class="hover:text-white transition-colors no-underline">Modpack Hub</a></li>
            <li><a href="https://uksfta.pro.unitcommander.co.uk" class="hover:text-white transition-colors no-underline">Portal Status</a></li>
          </ul>
        </div>

        <div class="md:col-span-3 space-y-6 text-right">
          <span class="text-[9px] font-black text-white uppercase tracking-[0.4em]">Node Status</span>
          <div class="flex flex-col items-end space-y-4">
              <div class="flex items-center space-x-3 bg-white/5 border border-white/10 px-4 py-2" id="server-status-container">
                  <span class="w-2 h-2 bg-gray-500 rounded-full" id="status-indicator"></span>
                  <span class="text-[9px] font-black text-gray-500 tracking-widest uppercase" id="status-text">INITIALIZING...</span>
              </div>
              <div class="flex flex-col items-end">
                <span class="text-[8px] font-mono text-gray-800 uppercase" id="player-count">SYNCING_DATA...</span>
                <span class="text-[8px] font-mono text-gray-800 uppercase mt-1">Primary Op: Wed 19:00 GMT</span>
                <span class="text-[9px] font-mono text-white font-black uppercase tracking-[0.4em] mt-4">Hub Registry: SIS-DIRECTORATE</span>
              </div>
          </div>
        </div>
      </div>
      
      <div class="pt-10 flex flex-col md:flex-row justify-between items-center gap-6">
        <span class="text-[8px] font-mono text-gray-700 tracking-[0.6em] uppercase font-bold">Â© 2026 Taskforce Alpha // Milsim Community</span>
        <div class="w-24 h-px bg-[var(--primary)] opacity-20"></div>
      </div>
    </div>
  </footer>

  <script>
    // BATTLEMETRICS_INTEGRATION //
    async function updateServerStatus() {
        const SERVER_ID = "35392879";
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('status-indicator');
        const playerCount = document.getElementById('player-count');
        const container = document.getElementById('server-status-container');

        try {
            const response = await fetch(`https://api.battlemetrics.com/servers/${SERVER_ID}`);
            const data = await response.json();
            const attributes = data.data.attributes;
            
            const isOnline = attributes.status === 'online';
            const players = attributes.players;
            const maxPlayers = attributes.maxPlayers;

            if (isOnline) {
                statusText.innerText = 'SERVER_LIVE';
                statusText.className = 'text-[9px] font-black text-green-500 tracking-widest uppercase';
                statusIndicator.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                container.className = 'flex items-center space-x-3 bg-green-500/5 border border-green-500/20 px-4 py-2';
                playerCount.innerText = `OPERATORS_IN_AO: ${players}/${maxPlayers}`;
            } else {
                statusText.innerText = 'NODE_OFFLINE';
                statusText.className = 'text-[9px] font-black text-red-500 tracking-widest uppercase';
                statusIndicator.className = 'w-2 h-2 bg-red-500 rounded-full';
                container.className = 'flex items-center space-x-3 bg-red-500/5 border border-red-500/20 px-4 py-2';
                playerCount.innerText = 'STATION_DARK';
            }
        } catch (error) {
            statusText.innerText = 'SYNC_ERROR';
            playerCount.innerText = 'CONNECTION_FAILED';
        }
    }

    // DISCORD_PORTAL_INTEGRATION //
    async function updateDiscordStatus() {
        const SERVER_ID = "{{ site.Params.discord.server_id }}";
        const onlineCounts = document.querySelectorAll('.discord-online-count');
        const signalStrengths = document.querySelectorAll('.signal-strength');
        const linkIds = document.querySelectorAll('.link-id');
        
        if (onlineCounts.length === 0 || !SERVER_ID) return;

        const startTime = performance.now();

        try {
            // Fetching from Discord's public widget API
            const response = await fetch(`https://discord.com/api/guilds/${SERVER_ID}/widget.json`);
            const data = await response.json();
            const endTime = performance.now();
            const latency = endTime - startTime;

            // Calculate realistic signal strength based on latency (fake jitter added)
            // Base 100, subtract 1 for every 10ms over 50ms, +/- 2% jitter
            let integrity = Math.max(20, Math.min(100, 100 - Math.floor((latency - 50) / 10)));
            integrity += Math.floor(Math.random() * 5) - 2; 
            if (integrity > 100) integrity = 100;

            if (data && data.presence_count !== undefined) {
                // padStart(2, '0') keeps the terminal aesthetic
                const countStr = data.presence_count.toString().padStart(2, '0');
                
                // Update Counts
                onlineCounts.forEach(el => {
                    el.innerText = countStr;
                    el.classList.remove('text-red-900');
                });

                // Update Signal Strength
                signalStrengths.forEach(el => {
                    el.innerText = `SIGNAL STRENGTH: ${integrity}%`;
                    // Visual color cue based on signal
                    if (integrity < 50) el.style.color = '#ef4444'; // red
                    else if (integrity < 80) el.style.color = '#eab308'; // yellow
                    else el.style.color = 'white';
                });

                // Update Dynamic Link ID (Net ID)
                // Format: DSC-[Last4ServerID]-[HexTimestamp]
                const timeHex = Math.floor(Date.now() / 1000).toString(16).toUpperCase().substr(-4);
                const serverSuffix = SERVER_ID.substr(SERVER_ID.length - 4);
                const netId = `NET_ID: DSC-${serverSuffix}-${timeHex}`;
                
                linkIds.forEach(el => {
                    el.innerText = netId;
                });

                console.log(`[JSFC_NODE] Comms Link: ${data.presence_count} Personnel Online. Latency: ${Math.round(latency)}ms`);
            }
        } catch (error) {
            console.error("DISCORD_INTEL: Link failure:", error);
            onlineCounts.forEach(el => {
                el.innerText = "??";
                el.classList.add('text-red-900');
            });
            signalStrengths.forEach(el => el.innerText = "SIGNAL: LOST");
        }
    }

    // Initialize Discord Intel
    {{ if site.Params.discord.enabled }}
    updateDiscordStatus();
    setInterval(updateDiscordStatus, 60000); 
    {{ end }}

    // Initialize Status
    updateServerStatus();
    setInterval(updateServerStatus, 60000); // Update every 60s

    // [INTEL_OVERRIDE] //
    // Gate Signature: /registry/gate
    // Protocol: SECURE_AUTH
    console.log("%c[UKSFTA_INTEL] SYSTEM_PORTAL_DETECTED", "color: #b3995d; font-family: monospace; font-size: 14px; font-weight: bold;");
    console.log("%cDECRYPTION_HINT: The authorized access path is encoded in the system headers.", "color: #666; font-family: monospace;");
    console.log("%cAUTH_ID: GHOST-OPERATOR", "color: #666; font-family: monospace;");

    // UNIT_COMMANDER_INTEGRATION
    const ucConfig = {{ site.Params.unitcommander | jsonify | safeJS }};

    if (ucConfig.enabled && ucConfig.community_id && ucConfig.bot_token) {
        async function fetchEvents() {
            const feeds = document.querySelectorAll('.live-ops-feed-container');
            if (feeds.length === 0) return;
        
            const startTime = performance.now();

            try {
                const response = await fetch(`https://api.unitcommander.co.uk/community/${ucConfig.community_id}/campaigns`, {
                    headers: { 'Authorization': `Bot ${ucConfig.bot_token}` }
                });
                const data = await response.json();
                
                const endTime = performance.now();
                const latency = endTime - startTime;
                
                // Calculate Uplink Quality
                let uplink = Math.max(40, Math.min(100, 100 - Math.floor((latency - 100) / 20)));
                uplink += Math.floor(Math.random() * 3); // Jitter
                if (uplink > 100) uplink = 100;

                if (data && Array.isArray(data) && data.length > 0) {
                    // Filter for ACTIVE and Sort by the most recent update (Event activity)
                    const latestOp = data
                        .filter(op => op.status === "ACTIVE")
                        .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))[0]; // Take only the top index
                
                    if (latestOp) {
                        const opTitle = latestOp.campaignName || "MISSION_UNNAMED";
                        const opDateRaw = latestOp.updated_at || latestOp.created_at;
                        const startDate = new Date(latestOp.created_at);
                        const today = new Date();
                        const diffTime = Math.abs(today - startDate);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                        const rawLocation = latestOp.map || "CLASSIFIED";
                        const cleanLocation = rawLocation.split('(')[0].trim().toUpperCase();

                        let dateStr = "TBD";
                        if (opDateRaw) {
                            const d = new Date(opDateRaw);
                            if (!isNaN(d)) {
                                dateStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                            }
                        }
                      
                        const html = `
                            <div class="p-6 bg-white/[0.02] border border-white/5 relative group overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-[var(--primary)] shadow-[0_0_15px_var(--primary)]"></div>

                                <div class="flex justify-between items-start mb-4">
                                    <span class="text-[8px] font-mono text-gray-500 uppercase tracking-widest">
                                        SIGNAL_ID: TF-${latestOp.id} // ${dateStr}
                                    </span>
                                    <div class="flex items-center gap-2 bg-white/[0.03] px-2 py-1 rounded-sm border border-white/5">
                                        <span class="text-[8px] font-mono text-gray-500 uppercase tracking-widest border-r border-white/10 pr-2 mr-2">Q:${uplink}%</span>
                                        <span class="relative flex h-1.5 w-1.5">
                                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--primary)] opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[var(--primary)]"></span>
                                        </span>
                                        <span class="text-[8px] font-black text-[var(--primary)] uppercase tracking-widest">ACTIVE</span>
                                    </div>
                                </div>
                              
                                <span class="text-2xl font-black text-white uppercase tracking-tighter block leading-tight mb-4">
                                    ${opTitle}
                                </span>

                                <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4 mb-3">
                                    <div class="flex flex-col">
                                        <span class="text-[7px] text-gray-600 font-mono uppercase">Deployment_Time</span>
                                        <span class="text-xs text-white font-bold font-mono">${diffDays}D</span>
                                    </div>
                                    <div class="flex flex-col border-l border-white/10 pl-4">
                                        <span class="text-[7px] text-gray-600 font-mono uppercase">Combat_Status</span>
                                        <span class="text-xs text-[var(--primary)] font-bold font-mono italic">ENGAGED</span>
                                    </div>
                                </div>
                              
                                <div class="flex flex-col border-t border-white/5 pt-3">
                                    <span class="text-[7px] text-gray-600 font-mono uppercase mb-1">Area_of_Operation</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-white font-bold font-mono tracking-tight">${cleanLocation}</span>
                                    </div>
                                </div>
                              
                                <div class="mt-5">
                                    <div class="w-full h-[1px] bg-white/5 relative overflow-hidden">
                                        <div class="absolute top-0 left-0 h-full bg-[var(--primary)] opacity-60" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        feeds.forEach(feed => feed.innerHTML = html);
                    } else {
                        const emptyHtml = '<div class="text-[8px] font-mono text-gray-700 uppercase tracking-widest p-6 border border-dashed border-white/5">No active deployments detected.</div>';
                        feeds.forEach(feed => feed.innerHTML = emptyHtml);
                    }
                }
            } catch (err) {
                console.error("UKSFTA_INTEL: Link failure:", err);
                const errorHtml = '<div class="text-[8px] font-mono text-red-900 uppercase tracking-widest p-6 border border-dashed border-red-900/20">Link failure: UC_NODE_OFFLINE</div>';
                feeds.forEach(feed => feed.innerHTML = errorHtml);
            }
        }
        fetchEvents();
    }

    // Hidden Trigger for curious personnel
    let clicks = 0;
    document.getElementById('ghost-node').addEventListener('click', () => {
        clicks++;
        if (clicks === 5) {
            console.log("%c[OVERRIDE_SEQUENCE_INITIATED]", "color: #ef4444; font-weight: bold;");
            console.log("%cPATH_DECRYPTED: /registry/gate", "color: #22c55e;");
        }
    });

    // Check Authorization State
    if (localStorage.getItem('uksf_auth') === 'authorized') {
        document.body.classList.add('operator-authenticated');
    }

    function updateClock() {
      const now = new Date();
      const h = String(now.getUTCHours()).padStart(2, '0');
      const m = String(now.getUTCMinutes()).padStart(2, '0');
      const s = String(now.getUTCSeconds()).padStart(2, '0');
      document.getElementById('clock').innerText = `${h}:${m}:${s}`;
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
  <script src="{{ "js/main.js" | relURL }}" defer></script>
  <!-- JSFC RECON: If you are looking for the primary node key, verify the system meta headers. Use Base64 protocols. -->
</body>
</html>
