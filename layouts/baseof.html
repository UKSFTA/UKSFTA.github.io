<!doctype html>
<html lang="{{ site.Language.LanguageCode | default "en-GB" }}" class="scroll-smooth">
  {{ $isMaintenance := eq .Type "maintenance" }}
  <head>
    {{ partial "head/index.html" . }}
    <script>
        // Early theme application to avoid FOUC and ensure accessibility audit accuracy
        const savedTheme = localStorage.getItem('moduk_theme');
        if (savedTheme === 'light') {
            document.documentElement.classList.add('light');
            document.documentElement.classList.remove('dark');
        } else {
            // Default to dark
            document.documentElement.classList.remove('light');
            document.documentElement.classList.add('dark');
        }
    </script>
    {{ if $isMaintenance }}
    <style>
        html, body { 
            height: 100vh !important; 
            width: 100vw !important; 
            overflow: hidden !important; 
            margin: 0 !important; 
            padding: 0 !important;
        }
    </style>
    {{ end }}
    {{ if site.Params.maintenance_mode }}
    <script>
        // Maintenance Mode Hard Gate
        if (window.location.pathname !== '/maintenance/' && localStorage.getItem('dev_access') !== 'granted') {
            window.location.href = '/maintenance/';
        }
    </script>
    {{ end }}
  </head>
  {{ $unit := .Params.unit | default .Section | default "sas" }}
  {{ $isRegistry := or (eq .Section "registry") (eq .Type "registry") (strings.HasPrefix .Layout "registry/") }}
  {{ $isMaintenance := eq .Type "maintenance" }}
  
  {{ if and $isRegistry (ne .Layout "gate") (ne .Layout "restricted") }}
    <script>
      if (localStorage.getItem('uksf_auth') !== 'authorized') {
        window.location.href = '/registry/gate/';
      }
    </script>
  {{ end }}
  <body class="unit-{{ .Params.unit | default .Section | default `global` }}">
    <!-- GLOBAL SYSTEM HUD (Fixed Components) -->
    {{ if not $isMaintenance }}
    <div class="fixed top-0 left-0 w-full z-[3000]">
        {{ partial "core/header.html" . }}
        {{ partial "core/phase-banner.html" . }}
    </div>
    {{ end }}

    <div id="main-content" role="main" class="flex-grow {{ if $isMaintenance }}h-full{{ end }}">
      {{ block "main" . }}{{ end }}
    </div>

    {{ if and (not .IsHome) (not $isMaintenance) }}
      {{ partial "core/footer.html" . }}
    {{ end }}

    {{ $core := resources.Get "js/system-core.js" | fingerprint }}
    <script src="{{ $core.RelPermalink }}" integrity="{{ $core.Data.Integrity }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initSystem) window.initSystem("{{ site.Params.discord.server_id }}");
        });
    </script>
    
    {{ partial "core/cookie-consent.html" . }}
  </body>
</html>
